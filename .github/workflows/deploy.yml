name: Build & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install server dependencies
        run: npm ci --prefix server
      
      - name: Install client dependencies
        run: npm ci --prefix client
      
      - name: Run server tests
        run: npm test --prefix server
        continue-on-error: true
        env:
          MONGODB_URI: mongodb://localhost:27017/thinkify_test
          NODE_ENV: test
          JWT_SECRET: test-secret-key-for-ci
      
      - name: Build client
        run: npm run build --prefix client
        env:
          VITE_API_URL: ${{ secrets.PRODUCTION_API_URL }}

  # Railway auto-deploys from GitHub on push to main
  # This job just verifies the build succeeds
  deploy-notification:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Deployment Status
        run: |
          echo "âœ… Build successful!"
          echo "ðŸš€ Railway will auto-deploy the server"
          echo "ðŸš€ Vercel will auto-deploy the client (if connected)"
          echo ""
          echo "Server: Railway auto-deploys from main branch"
          echo "Client: Vercel auto-deploys from main branch"
